.PHONY: help build up down restart logs clean streamlit api stop-streamlit stop-api

# Couleurs pour l'affichage
GREEN=\033[0;32m
YELLOW=\033[1;33m
NC=\033[0m # No Color

help: ## Afficher l'aide
	@echo "$(GREEN)‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê$(NC)"
	@echo "$(GREEN)   GreenTech Solutions - Commandes Docker$(NC)"
	@echo "$(GREEN)‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê$(NC)"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "$(YELLOW)%-20s$(NC) %s\n", $$1, $$2}'

build: ## Construire les images Docker
	@echo "$(GREEN)üî® Construction des images Docker...$(NC)"
	docker-compose build

up: ## D√©marrer tous les services
	@echo "$(GREEN)üöÄ D√©marrage de tous les services...$(NC)"
	docker-compose up -d
	@echo "$(GREEN)‚úÖ Services d√©marr√©s !$(NC)"
	@echo "$(YELLOW)üìä Streamlit: http://localhost:8501$(NC)"
	@echo "$(YELLOW)üîå API: http://localhost:8000$(NC)"

down: ## Arr√™ter tous les services
	@echo "$(GREEN)üõë Arr√™t de tous les services...$(NC)"
	docker-compose down

restart: down up ## Red√©marrer tous les services

streamlit: ## D√©marrer uniquement Streamlit
	@echo "$(GREEN)üìä D√©marrage de Streamlit...$(NC)"
	docker-compose up -d streamlit
	@echo "$(GREEN)‚úÖ Streamlit d√©marr√© sur http://localhost:8501$(NC)"

api: ## D√©marrer uniquement l'API
	@echo "$(GREEN)üîå D√©marrage de l'API...$(NC)"
	docker-compose up -d api
	@echo "$(GREEN)‚úÖ API d√©marr√©e sur http://localhost:8000$(NC)"

stop-streamlit: ## Arr√™ter Streamlit
	@echo "$(GREEN)üõë Arr√™t de Streamlit...$(NC)"
	docker-compose stop streamlit

stop-api: ## Arr√™ter l'API
	@echo "$(GREEN)üõë Arr√™t de l'API...$(NC)"
	docker-compose stop api

logs: ## Voir les logs de tous les services
	docker-compose logs -f

logs-streamlit: ## Voir les logs de Streamlit
	docker-compose logs -f streamlit

logs-api: ## Voir les logs de l'API
	docker-compose logs -f api

ps: ## Voir l'√©tat des services
	@echo "$(GREEN)üìä √âtat des services:$(NC)"
	@docker-compose ps

shell-streamlit: ## Ouvrir un shell dans le conteneur Streamlit
	docker-compose exec streamlit /bin/bash

shell-api: ## Ouvrir un shell dans le conteneur API
	docker-compose exec api /bin/bash

clean: ## Nettoyer les conteneurs, images et volumes
	@echo "$(YELLOW)‚ö†Ô∏è  Nettoyage complet (conteneurs, images, volumes)...$(NC)"
	docker-compose down -v
	docker system prune -f
	@echo "$(GREEN)‚úÖ Nettoyage termin√©$(NC)"

rebuild: clean build up ## Reconstruire et red√©marrer tout

health: ## V√©rifier la sant√© des services
	@echo "$(GREEN)üè• V√©rification de la sant√© des services:$(NC)"
	@docker inspect --format='{{.State.Health.Status}}' greentech-streamlit 2>/dev/null || echo "Streamlit: non d√©marr√©"
	@docker inspect --format='{{.State.Health.Status}}' greentech-api 2>/dev/null || echo "API: non d√©marr√©"